\doxysection{sklearn.\+externals.\+array\+\_\+api\+\_\+extra.\+testing Namespace Reference}
\hypertarget{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing}{}\label{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing}\index{sklearn.externals.array\_api\_extra.testing@{sklearn.externals.array\_api\_extra.testing}}
\doxysubsubsection*{Classes}
\begin{DoxyCompactItemize}
\item 
class \mbox{\hyperlink{classsklearn_1_1externals_1_1array__api__extra_1_1testing_1_1CountingDaskScheduler}{Counting\+Dask\+Scheduler}}
\end{DoxyCompactItemize}
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
object \mbox{\hyperlink{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing_adf2f057cadf31559379e02f1531238de}{override}} (object func)
\item 
None \mbox{\hyperlink{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing_a0a1d52594f91571f2ccc4f3501e44a00}{lazy\+\_\+xp\+\_\+function}} (Callable\mbox{[}..., Any\mbox{]} func, \texorpdfstring{$\ast$}{*}, int allow\+\_\+dask\+\_\+compute=0, bool jax\+\_\+jit=\mbox{\hyperlink{classTrue}{True}}, int\texorpdfstring{$\vert$}{|}Sequence\mbox{[}int\mbox{]}\texorpdfstring{$\vert$}{|}None static\+\_\+argnums=None, str\texorpdfstring{$\vert$}{|}Iterable\mbox{[}str\mbox{]}\texorpdfstring{$\vert$}{|}None static\+\_\+argnames=None)
\item 
None \mbox{\hyperlink{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing_aa9f1c924dec4faf5a5c30f7dbfcbbe45}{patch\+\_\+lazy\+\_\+xp\+\_\+functions}} (pytest.\+Fixture\+Request request, pytest.\+Monkey\+Patch monkeypatch, \texorpdfstring{$\ast$}{*}, Module\+Type xp)
\item 
Callable\mbox{[}P, T\mbox{]} \mbox{\hyperlink{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing_ab920aeb4aefb7c55229436d01a05467e}{\+\_\+dask\+\_\+wrap}} (Callable\mbox{[}P, T\mbox{]} func, int n)
\end{DoxyCompactItemize}
\doxysubsubsection*{Variables}
\begin{DoxyCompactItemize}
\item 
list \mbox{\hyperlink{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing_a7c83463ba6f1101388eff4230d87e75e}{\+\_\+\+\_\+all\+\_\+\+\_\+}} = \mbox{[}"{}lazy\+\_\+xp\+\_\+function"{}, "{}patch\+\_\+lazy\+\_\+xp\+\_\+functions"{}\mbox{]}
\item 
\mbox{\hyperlink{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing_aa8bafdb0be3373fb9c27eb5ad0c46c47}{Scheduler\+Get\+Callable}} = object
\item 
\mbox{\hyperlink{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing_a86dd63df3b8ed91ebff80578eb054619}{P}} = Param\+Spec("{}P"{})
\item 
\mbox{\hyperlink{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing_a16b84cfdf77e50858a53327bd6c90957}{T}} = Type\+Var("{}T"{})
\item 
dict \mbox{\hyperlink{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing_a7bd223385b2a6e53ba58dd4832e42c27}{\+\_\+ufuncs\+\_\+tags}} = \{\}
\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
\begin{DoxyVerb}Public testing utilities.

See also _lib._testing for additional private testing utilities.
\end{DoxyVerb}
 

\doxysubsection{Function Documentation}
\Hypertarget{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing_ab920aeb4aefb7c55229436d01a05467e}\index{sklearn.externals.array\_api\_extra.testing@{sklearn.externals.array\_api\_extra.testing}!\_dask\_wrap@{\_dask\_wrap}}
\index{\_dask\_wrap@{\_dask\_wrap}!sklearn.externals.array\_api\_extra.testing@{sklearn.externals.array\_api\_extra.testing}}
\doxysubsubsection{\texorpdfstring{\_dask\_wrap()}{\_dask\_wrap()}}
{\footnotesize\ttfamily \label{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing_ab920aeb4aefb7c55229436d01a05467e} 
 Callable\mbox{[}P, T\mbox{]} sklearn.\+externals.\+array\+\_\+api\+\_\+extra.\+testing.\+\_\+dask\+\_\+wrap (\begin{DoxyParamCaption}\item[{Callable\mbox{[}P, T\mbox{]}}]{func}{, }\item[{int }]{n}{}\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [protected]}}

\begin{DoxyVerb}Wrap `func` to raise if it attempts to call `dask.compute` more than `n` times.

After the function returns, materialize the graph in order to re-raise exceptions.
\end{DoxyVerb}
 

Definition at line \mbox{\hyperlink{sklearn_2externals_2array__api__extra_2testing_8py_source_l00294}{294}} of file \mbox{\hyperlink{sklearn_2externals_2array__api__extra_2testing_8py_source}{testing.\+py}}.



Referenced by \mbox{\hyperlink{sklearn_2externals_2array__api__extra_2testing_8py_source_l00181}{patch\+\_\+lazy\+\_\+xp\+\_\+functions()}}.

\Hypertarget{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing_a0a1d52594f91571f2ccc4f3501e44a00}\index{sklearn.externals.array\_api\_extra.testing@{sklearn.externals.array\_api\_extra.testing}!lazy\_xp\_function@{lazy\_xp\_function}}
\index{lazy\_xp\_function@{lazy\_xp\_function}!sklearn.externals.array\_api\_extra.testing@{sklearn.externals.array\_api\_extra.testing}}
\doxysubsubsection{\texorpdfstring{lazy\_xp\_function()}{lazy\_xp\_function()}}
{\footnotesize\ttfamily \label{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing_a0a1d52594f91571f2ccc4f3501e44a00} 
 None sklearn.\+externals.\+array\+\_\+api\+\_\+extra.\+testing.\+lazy\+\_\+xp\+\_\+function (\begin{DoxyParamCaption}\item[{Callable\mbox{[}..., Any\mbox{]}}]{func}{, }\item[{\texorpdfstring{$\ast$}{*}}]{}{, }\item[{int }]{allow\+\_\+dask\+\_\+compute}{ = {\ttfamily 0}, }\item[{bool }]{jax\+\_\+jit}{ = {\ttfamily \mbox{\hyperlink{classTrue}{True}}}, }\item[{int \texorpdfstring{$\vert$}{|} Sequence\mbox{[}int\mbox{]} \texorpdfstring{$\vert$}{|} None }]{static\+\_\+argnums}{ = {\ttfamily None}, }\item[{str \texorpdfstring{$\vert$}{|} Iterable\mbox{[}str\mbox{]} \texorpdfstring{$\vert$}{|} None }]{static\+\_\+argnames}{ = {\ttfamily None}}\end{DoxyParamCaption})}

\begin{DoxyVerb}Tag a function to be tested on lazy backends.

Tag a function so that when any tests are executed with ``xp=jax.numpy`` the
function is replaced with a jitted version of itself, and when it is executed with
``xp=dask.array`` the function will raise if it attempts to materialize the graph.
This will be later expanded to provide test coverage for other lazy backends.

In order for the tag to be effective, the test or a fixture must call
:func:`patch_lazy_xp_functions`.

Parameters
----------
func : callable
    Function to be tested.
allow_dask_compute : int, optional
    Number of times `func` is allowed to internally materialize the Dask graph. This
    is typically triggered by ``bool()``, ``float()``, or ``np.asarray()``.

    Set to 1 if you are aware that `func` converts the input parameters to NumPy and
    want to let it do so at least for the time being, knowing that it is going to be
    extremely detrimental for performance.

    If a test needs values higher than 1 to pass, it is a canary that the conversion
    to NumPy/bool/float is happening multiple times, which translates to multiple
    computations of the whole graph. Short of making the function fully lazy, you
    should at least add explicit calls to ``np.asarray()`` early in the function.
    *Note:* the counter of `allow_dask_compute` resets after each call to `func`, so
    a test function that invokes `func` multiple times should still work with this
    parameter set to 1.

    Default: 0, meaning that `func` must be fully lazy and never materialize the
    graph.
jax_jit : bool, optional
    Set to True to replace `func` with ``jax.jit(func)`` after calling the
    :func:`patch_lazy_xp_functions` test helper with ``xp=jax.numpy``. Set to False
    if `func` is only compatible with eager (non-jitted) JAX. Default: True.
static_argnums : int | Sequence[int], optional
    Passed to jax.jit. Positional arguments to treat as static (compile-time
    constant). Default: infer from `static_argnames` using
    `inspect.signature(func)`.
static_argnames : str | Iterable[str], optional
    Passed to jax.jit. Named arguments to treat as static (compile-time constant).
    Default: infer from `static_argnums` using `inspect.signature(func)`.

See Also
--------
patch_lazy_xp_functions : Companion function to call from the test or fixture.
jax.jit : JAX function to compile a function for performance.

Examples
--------
In ``test_mymodule.py``::

  from array_api_extra.testing import lazy_xp_function from mymodule import myfunc

  lazy_xp_function(myfunc)

  def test_myfunc(xp):
      a = xp.asarray([1, 2])
      # When xp=jax.numpy, this is the same as `b = jax.jit(myfunc)(a)`
      # When xp=dask.array, crash on compute() or persist()
      b = myfunc(a)

Notes
-----
In order for this tag to be effective, the test function must be imported into the
test module globals without its namespace; alternatively its namespace must be
declared in a ``lazy_xp_modules`` list in the test module globals.

Example 1::

  from mymodule import myfunc

  lazy_xp_function(myfunc)

  def test_myfunc(xp):
      x = myfunc(xp.asarray([1, 2]))

Example 2::

  import mymodule

  lazy_xp_modules = [mymodule]
  lazy_xp_function(mymodule.myfunc)

  def test_myfunc(xp):
      x = mymodule.myfunc(xp.asarray([1, 2]))

A test function can circumvent this monkey-patching system by using a namespace
outside of the two above patterns. You need to sanitize your code to make sure this
only happens intentionally.

Example 1::

  import mymodule
  from mymodule import myfunc

  lazy_xp_function(myfunc)

  def test_myfunc(xp):
      a = xp.asarray([1, 2])
      b = myfunc(a)  # This is wrapped when xp=jax.numpy or xp=dask.array
      c = mymodule.myfunc(a)  # This is not

Example 2::

  import mymodule

  class naked:
      myfunc = mymodule.myfunc

  lazy_xp_modules = [mymodule]
  lazy_xp_function(mymodule.myfunc)

  def test_myfunc(xp):
      a = xp.asarray([1, 2])
      b = mymodule.myfunc(a)  # This is wrapped when xp=jax.numpy or xp=dask.array
      c = naked.myfunc(a)  # This is not
\end{DoxyVerb}
 

Definition at line \mbox{\hyperlink{sklearn_2externals_2array__api__extra_2testing_8py_source_l00039}{39}} of file \mbox{\hyperlink{sklearn_2externals_2array__api__extra_2testing_8py_source}{testing.\+py}}.

\Hypertarget{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing_adf2f057cadf31559379e02f1531238de}\index{sklearn.externals.array\_api\_extra.testing@{sklearn.externals.array\_api\_extra.testing}!override@{override}}
\index{override@{override}!sklearn.externals.array\_api\_extra.testing@{sklearn.externals.array\_api\_extra.testing}}
\doxysubsubsection{\texorpdfstring{override()}{override()}}
{\footnotesize\ttfamily \label{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing_adf2f057cadf31559379e02f1531238de} 
 object sklearn.\+externals.\+array\+\_\+api\+\_\+extra.\+testing.\+override (\begin{DoxyParamCaption}\item[{object}]{func}{}\end{DoxyParamCaption})}



Definition at line \mbox{\hyperlink{sklearn_2externals_2array__api__extra_2testing_8py_source_l00029}{29}} of file \mbox{\hyperlink{sklearn_2externals_2array__api__extra_2testing_8py_source}{testing.\+py}}.

\Hypertarget{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing_aa9f1c924dec4faf5a5c30f7dbfcbbe45}\index{sklearn.externals.array\_api\_extra.testing@{sklearn.externals.array\_api\_extra.testing}!patch\_lazy\_xp\_functions@{patch\_lazy\_xp\_functions}}
\index{patch\_lazy\_xp\_functions@{patch\_lazy\_xp\_functions}!sklearn.externals.array\_api\_extra.testing@{sklearn.externals.array\_api\_extra.testing}}
\doxysubsubsection{\texorpdfstring{patch\_lazy\_xp\_functions()}{patch\_lazy\_xp\_functions()}}
{\footnotesize\ttfamily \label{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing_aa9f1c924dec4faf5a5c30f7dbfcbbe45} 
 None sklearn.\+externals.\+array\+\_\+api\+\_\+extra.\+testing.\+patch\+\_\+lazy\+\_\+xp\+\_\+functions (\begin{DoxyParamCaption}\item[{pytest.\+Fixture\+Request}]{request}{, }\item[{pytest.\+Monkey\+Patch}]{monkeypatch}{, }\item[{\texorpdfstring{$\ast$}{*}}]{}{, }\item[{Module\+Type }]{xp}{}\end{DoxyParamCaption})}

\begin{DoxyVerb}Test lazy execution of functions tagged with :func:`lazy_xp_function`.

If ``xp==jax.numpy``, search for all functions which have been tagged with
:func:`lazy_xp_function` in the globals of the module that defines the current test,
as well as in the ``lazy_xp_modules`` list in the globals of the same module,
and wrap them with :func:`jax.jit`. Unwrap them at the end of the test.

If ``xp==dask.array``, wrap the functions with a decorator that disables
``compute()`` and ``persist()`` and ensures that exceptions and warnings are raised
eagerly.

This function should be typically called by your library's `xp` fixture that runs
tests on multiple backends::

    @pytest.fixture(params=[numpy, array_api_strict, jax.numpy, dask.array])
    def xp(request, monkeypatch):
        patch_lazy_xp_functions(request, monkeypatch, xp=request.param)
        return request.param

but it can be otherwise be called by the test itself too.

Parameters
----------
request : pytest.FixtureRequest
    Pytest fixture, as acquired by the test itself or by one of its fixtures.
monkeypatch : pytest.MonkeyPatch
    Pytest fixture, as acquired by the test itself or by one of its fixtures.
xp : array_namespace
    Array namespace to be tested.

See Also
--------
lazy_xp_function : Tag a function to be tested on lazy backends.
pytest.FixtureRequest : `request` test function parameter.
\end{DoxyVerb}
 

Definition at line \mbox{\hyperlink{sklearn_2externals_2array__api__extra_2testing_8py_source_l00179}{179}} of file \mbox{\hyperlink{sklearn_2externals_2array__api__extra_2testing_8py_source}{testing.\+py}}.



References \mbox{\hyperlink{sklearn_2externals_2array__api__extra_2testing_8py_source_l00296}{\+\_\+dask\+\_\+wrap()}}.



\doxysubsection{Variable Documentation}
\Hypertarget{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing_a7c83463ba6f1101388eff4230d87e75e}\index{sklearn.externals.array\_api\_extra.testing@{sklearn.externals.array\_api\_extra.testing}!\_\_all\_\_@{\_\_all\_\_}}
\index{\_\_all\_\_@{\_\_all\_\_}!sklearn.externals.array\_api\_extra.testing@{sklearn.externals.array\_api\_extra.testing}}
\doxysubsubsection{\texorpdfstring{\_\_all\_\_}{\_\_all\_\_}}
{\footnotesize\ttfamily \label{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing_a7c83463ba6f1101388eff4230d87e75e} 
list sklearn.\+externals.\+array\+\_\+api\+\_\+extra.\+testing.\+\_\+\+\_\+all\+\_\+\+\_\+ = \mbox{[}"{}lazy\+\_\+xp\+\_\+function"{}, "{}patch\+\_\+lazy\+\_\+xp\+\_\+functions"{}\mbox{]}\hspace{0.3cm}{\ttfamily [private]}}



Definition at line \mbox{\hyperlink{sklearn_2externals_2array__api__extra_2testing_8py_source_l00017}{17}} of file \mbox{\hyperlink{sklearn_2externals_2array__api__extra_2testing_8py_source}{testing.\+py}}.

\Hypertarget{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing_a7bd223385b2a6e53ba58dd4832e42c27}\index{sklearn.externals.array\_api\_extra.testing@{sklearn.externals.array\_api\_extra.testing}!\_ufuncs\_tags@{\_ufuncs\_tags}}
\index{\_ufuncs\_tags@{\_ufuncs\_tags}!sklearn.externals.array\_api\_extra.testing@{sklearn.externals.array\_api\_extra.testing}}
\doxysubsubsection{\texorpdfstring{\_ufuncs\_tags}{\_ufuncs\_tags}}
{\footnotesize\ttfamily \label{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing_a7bd223385b2a6e53ba58dd4832e42c27} 
dict sklearn.\+externals.\+array\+\_\+api\+\_\+extra.\+testing.\+\_\+ufuncs\+\_\+tags = \{\}\hspace{0.3cm}{\ttfamily [protected]}}



Definition at line \mbox{\hyperlink{sklearn_2externals_2array__api__extra_2testing_8py_source_l00036}{36}} of file \mbox{\hyperlink{sklearn_2externals_2array__api__extra_2testing_8py_source}{testing.\+py}}.

\Hypertarget{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing_a86dd63df3b8ed91ebff80578eb054619}\index{sklearn.externals.array\_api\_extra.testing@{sklearn.externals.array\_api\_extra.testing}!P@{P}}
\index{P@{P}!sklearn.externals.array\_api\_extra.testing@{sklearn.externals.array\_api\_extra.testing}}
\doxysubsubsection{\texorpdfstring{P}{P}}
{\footnotesize\ttfamily \label{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing_a86dd63df3b8ed91ebff80578eb054619} 
sklearn.\+externals.\+array\+\_\+api\+\_\+extra.\+testing.\+P = Param\+Spec("{}P"{})}



Definition at line \mbox{\hyperlink{sklearn_2externals_2array__api__extra_2testing_8py_source_l00033}{33}} of file \mbox{\hyperlink{sklearn_2externals_2array__api__extra_2testing_8py_source}{testing.\+py}}.

\Hypertarget{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing_aa8bafdb0be3373fb9c27eb5ad0c46c47}\index{sklearn.externals.array\_api\_extra.testing@{sklearn.externals.array\_api\_extra.testing}!SchedulerGetCallable@{SchedulerGetCallable}}
\index{SchedulerGetCallable@{SchedulerGetCallable}!sklearn.externals.array\_api\_extra.testing@{sklearn.externals.array\_api\_extra.testing}}
\doxysubsubsection{\texorpdfstring{SchedulerGetCallable}{SchedulerGetCallable}}
{\footnotesize\ttfamily \label{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing_aa8bafdb0be3373fb9c27eb5ad0c46c47} 
sklearn.\+externals.\+array\+\_\+api\+\_\+extra.\+testing.\+Scheduler\+Get\+Callable = object}



Definition at line \mbox{\hyperlink{sklearn_2externals_2array__api__extra_2testing_8py_source_l00027}{27}} of file \mbox{\hyperlink{sklearn_2externals_2array__api__extra_2testing_8py_source}{testing.\+py}}.

\Hypertarget{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing_a16b84cfdf77e50858a53327bd6c90957}\index{sklearn.externals.array\_api\_extra.testing@{sklearn.externals.array\_api\_extra.testing}!T@{T}}
\index{T@{T}!sklearn.externals.array\_api\_extra.testing@{sklearn.externals.array\_api\_extra.testing}}
\doxysubsubsection{\texorpdfstring{T}{T}}
{\footnotesize\ttfamily \label{namespacesklearn_1_1externals_1_1array__api__extra_1_1testing_a16b84cfdf77e50858a53327bd6c90957} 
sklearn.\+externals.\+array\+\_\+api\+\_\+extra.\+testing.\+T = Type\+Var("{}T"{})}



Definition at line \mbox{\hyperlink{sklearn_2externals_2array__api__extra_2testing_8py_source_l00034}{34}} of file \mbox{\hyperlink{sklearn_2externals_2array__api__extra_2testing_8py_source}{testing.\+py}}.

